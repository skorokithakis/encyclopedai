{% load static %}<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{% block title %}{% endblock %} - {{ request.site.name }}</title>
    {% block extra_head %}{% endblock %}

    <link href="{% static "css/main.css" %}" rel="stylesheet">
    <script src="{% static "js/base.js" %}"></script>
    <script>
        window.__mathjaxTypesetQueue = [];
        window.__mathjaxIsReady = false;

        const __mathjaxPatterns = [
            /\$\$[\s\S]+?\$\$/,
            /\$(?!\s)[\s\S]+?\$/,
            /\\\([\s\S]+?\\\)/,
            /\\\[[\s\S]+?\\\]/,
        ];

        function __elementHasMathDelimiters(element) {
            if (!element) {
                return false;
            }
            const textContent = element.textContent || "";
            if (!textContent) {
                return false;
            }
            const sanitized = textContent.replace(/\\\$/g, "");
            return __mathjaxPatterns.some((pattern) => pattern.test(sanitized));
        }

        window.requestMathTypeset = function(element) {
            const target = element || document.body || null;
            if (!target || !__elementHasMathDelimiters(target)) {
                return;
            }
            if (window.__mathjaxIsReady && window.MathJax && MathJax.typesetPromise) {
                const renderPromise = MathJax.typesetPromise([target]);
                renderPromise.catch(function(error) {
                    console.error("MathJax rendering failed", error);
                });
                return;
            }
            window.__mathjaxTypesetQueue.push(target);
        };

        window.MathJax = {
            tex: {
                inlineMath: [["$", "$"], ["\\(", "\\)"]],
                displayMath: [["$$", "$$"], ["\\[", "\\]"]],
                processEscapes: true,
            },
            startup: {
                typeset: false,
                ready: () => {
                    MathJax.startup.defaultReady();
                    window.__mathjaxIsReady = true;
                    const pendingTargets = window.__mathjaxTypesetQueue || [];
                    window.__mathjaxTypesetQueue = [];
                    const initialRender = MathJax.typesetPromise();
                    const followUpRender = () =>
                        Promise.all(
                            pendingTargets
                                .filter(__elementHasMathDelimiters)
                                .map((target) => MathJax.typesetPromise([target]))
                        );
                    initialRender
                        .then(followUpRender)
                        .catch((error) => {
                            console.error("MathJax rendering failed", error);
                        });
                },
            },
        };
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/4.0.0/tex-mml-chtml.min.js" integrity="sha512-yxTB34XQUKlyuz73upeDrZ91/tbZW/YAURVWL3s+09bEWdmORQzUZwSKyBIRxSeHuSwh1aOKEffn2/D65kwyYg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
</head>
<body>
    {% block content %}
    {% endblock %}
    <script>
        (function() {
            if (typeof window.requestMathTypeset === "function") {
                window.requestMathTypeset(document.body);
            }
        })();
    </script>
</body>
</html>
