name: ðŸš€ Deploy to Dokku

on:
  workflow_run:
    workflows: ["pre-commit"]
    types:
      - completed
    branches: [ master ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.event == 'push' }}

    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: ðŸ” Setup SSH
      uses: webfactory/ssh-agent@v0.9.0
      with:
        ssh-private-key: ${{ secrets.DOKKU_SSH_KEY }}

    - name: ðŸ”§ Configure SSH
      run: |
        mkdir -p ~/.ssh
        echo "Host projects.stavros.io" >> ~/.ssh/config
        echo "  Port 16022" >> ~/.ssh/config
        echo "  StrictHostKeyChecking no" >> ~/.ssh/config
        echo "  UserKnownHostsFile=/dev/null" >> ~/.ssh/config

    - name: ðŸš€ Deploy to Dokku
      run: |
        git remote add dokku dokku@projects.stavros.io:encyclopedai
        git push dokku master
